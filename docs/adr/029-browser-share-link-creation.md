# ADR 029: Browser-based Share Link Creation

## Status

Accepted

## Context

ADR 026 ã§å®Ÿè£…ã—ãŸèª­ã¿å–ã‚Šå°‚ç”¨å…±æœ‰ãƒªãƒ³ã‚¯ã¯ CLI ã‹ã‚‰ã®ã¿ä½œæˆå¯èƒ½ã ã£ãŸã€‚ã—ã‹ã—ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ä½¿ç”¨ä¸­ã«å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œã—ãŸã„ã‚±ãƒ¼ã‚¹ãŒå¤šã„ï¼š

- ãƒªãƒ¢ãƒ¼ãƒˆãƒšã‚¢ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ä¸­ã«ç›¸æ‰‹ã‚’æ‹›å¾…
- ã‚µãƒãƒ¼ãƒˆä¸­ã«ç”»é¢ã‚’å…±æœ‰
- ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®å…±æœ‰ï¼ˆCLI ã‚¢ã‚¯ã‚»ã‚¹ãŒå›°é›£ï¼‰

ã¾ãŸã€æ—¢å­˜ã® `NotificationManager` ã‚„ `ShareManager`ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰ã§ã¯ URL ã‹ã‚‰ base path ã‚’æ¨æ¸¬ã—ã¦ã„ãŸãŒã€ã“ã‚Œã¯ä¿¡é ¼æ€§ã«æ¬ ã‘ã‚‹ï¼š

```typescript
// å•é¡Œã®ã‚ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
private getBasePath(): string {
  const pathParts = window.location.pathname.split('/');
  return '/' + (pathParts[1] || 'ttyd-mux');
}
```

## Decision

### 1. ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã«å…±æœ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 

é€šçŸ¥ãƒœã‚¿ãƒ³ (ğŸ””) ã®éš£ã«å…±æœ‰ãƒœã‚¿ãƒ³ (ğŸ”—) ã‚’é…ç½®ï¼š

```
[Ctrl][Alt][Shift]... [ğŸ”][ğŸ””][ğŸ”—]... [â–¼]
```

### 2. ãƒ¢ãƒ¼ãƒ€ãƒ« UI ã«ã‚ˆã‚‹å…±æœ‰ãƒªãƒ³ã‚¯ä½œæˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èª­ã¿å–ã‚Šå°‚ç”¨ãƒªãƒ³ã‚¯ã‚’ä½œæˆ        [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœ‰åŠ¹æœŸé™:                               â”‚
â”‚ â—‹ 1æ™‚é–“  â— 24æ™‚é–“  â—‹ 7æ—¥              â”‚
â”‚                                         â”‚
â”‚ [ãƒªãƒ³ã‚¯ã‚’ä½œæˆ]                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (ä½œæˆå¾Œ)                                â”‚
â”‚ https://example.com/ttyd-mux/s/abc123   â”‚
â”‚ [ã‚³ãƒ”ãƒ¼] [QRã‚³ãƒ¼ãƒ‰]                     â”‚
â”‚                                         â”‚
â”‚ âš  ã“ã®ãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã¯èª°ã§ã‚‚     â”‚
â”‚   ã“ã®ç«¯æœ«ã‚’é–²è¦§ã§ãã¾ã™               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã® base_path æ³¨å…¥

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ URL ã‹ã‚‰æ¨æ¸¬ã™ã‚‹ã®ã§ã¯ãªãã€ã‚µãƒ¼ãƒãƒ¼å´ã§ `__TOOLBAR_CONFIG__` ã« `base_path` ã‚’æ³¨å…¥ï¼š

```typescript
// src/daemon/toolbar/index.ts
export function injectToolbar(html: string, basePath: string, config: ToolbarConfig): string {
  const clientConfig = { ...config, base_path: basePath };
  const configScript = `<script>window.__TOOLBAR_CONFIG__ = ${JSON.stringify(clientConfig)};</script>`;
  // ...
}
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯è¨­å®šã‹ã‚‰å–å¾—ï¼š

```typescript
// ShareManager.ts, NotificationManager.ts
const basePath = this.config.base_path;
```

### 4. ShareManager ã‚¯ãƒ©ã‚¹

`NotificationManager` ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…ï¼š

```typescript
export class ShareManager {
  private config: ToolbarConfig;

  constructor(config: ToolbarConfig) {
    this.config = config;
  }

  async createShare(): Promise<void> {
    const response = await fetch(`${this.config.base_path}/api/shares`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionName, expiresIn })
    });
    // ...
  }
}
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Server (injectToolbar)                    â”‚
â”‚  __TOOLBAR_CONFIG__ = { base_path: "/ttyd-mux", ... }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Browser Client                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ToolbarApp                                                  â”‚
â”‚    â”œâ”€â”€ ShareManager(config)                                  â”‚
â”‚    â”‚     â””â”€â”€ POST /api/shares                                â”‚
â”‚    â”œâ”€â”€ NotificationManager(config)                           â”‚
â”‚    â”‚     â””â”€â”€ POST /api/notifications/subscribe               â”‚
â”‚    â””â”€â”€ ... (other managers)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REST API                                â”‚
â”‚  POST /api/shares â†’ { token, sessionName, expiresAt }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Changes

| File | Change |
|------|--------|
| `src/daemon/toolbar/template.ts` | ğŸ”— ãƒœã‚¿ãƒ³ã¨ãƒ¢ãƒ¼ãƒ€ãƒ« HTML è¿½åŠ  |
| `src/daemon/toolbar/styles.ts` | ãƒ¢ãƒ¼ãƒ€ãƒ« CSS è¿½åŠ  |
| `src/daemon/toolbar/client/ShareManager.ts` | æ–°è¦: å…±æœ‰ãƒªãƒ³ã‚¯ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ |
| `src/daemon/toolbar/client/types.ts` | `ToolbarConfig` ã« `base_path` è¿½åŠ  |
| `src/daemon/toolbar/client/index.ts` | ShareManager åˆæœŸåŒ– |
| `src/daemon/toolbar/index.ts` | config ã« basePath ã‚’ãƒãƒ¼ã‚¸ |
| `src/daemon/toolbar/client/NotificationManager.ts` | config ã‹ã‚‰ base_path å–å¾—ã«å¤‰æ›´ |

## Consequences

### Positive

- ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç™ºè¡Œå¯èƒ½
- ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã‚‚å…±æœ‰ãƒªãƒ³ã‚¯ä½œæˆãŒå®¹æ˜“
- base_path ãŒã‚µãƒ¼ãƒãƒ¼è¨­å®šã¨ä¸€è‡´ã™ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹
- QR ã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ã§ URL å…±æœ‰ãŒç°¡å˜
- æ—¢å­˜ã®é€šçŸ¥ãƒœã‚¿ãƒ³ã¨ä¸€è²«ã—ãŸ UI ãƒ‘ã‚¿ãƒ¼ãƒ³

### Negative

- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒœã‚¿ãƒ³æ•°ãŒå¢—åŠ ï¼ˆæ¨ªå¹…ãŒåºƒãŒã‚‹ï¼‰
- QR ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã‚Šãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒç´„ 20KB å¢—åŠ 

## Notes

### QR ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

`qrcode-generator` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§ç”Ÿæˆï¼š

```typescript
import qrcode from 'qrcode-generator';

const qr = qrcode(0, 'L');  // type 0 = auto, L = low error correction
qr.addData(url);
qr.make();
const dataUrl = qr.createDataURL(4, 4);  // cell size, margin
```

- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ä¾å­˜ãªã—
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œ
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ï¼ˆURL ãŒå¤–éƒ¨ã«é€ä¿¡ã•ã‚Œãªã„ï¼‰

### ã‚»ãƒƒã‚·ãƒ§ãƒ³åã®å–å¾—

ã‚»ãƒƒã‚·ãƒ§ãƒ³åã¯ URL ãƒ‘ã‚¹ã‹ã‚‰å–å¾—ï¼ˆ`/ttyd-mux/<session-name>/...`ï¼‰ã€‚ã“ã‚Œã¯ base_path ã¨ç•°ãªã‚Šã€å‹•çš„ã«å¤‰åŒ–ã™ã‚‹ãŸã‚ URL ã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

### Related ADRs

- ADR 026: Read-only Share Linksï¼ˆåŸºç›¤ã¨ãªã‚‹å…±æœ‰ãƒªãƒ³ã‚¯æ©Ÿèƒ½ï¼‰
- ADR 027: Push Notificationsï¼ˆåŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ NotificationManager ã‚’å®Ÿè£…ï¼‰
- ADR 016: Toolbar Configurationï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒ¼è¨­å®šã®æ³¨å…¥æ–¹å¼ï¼‰
